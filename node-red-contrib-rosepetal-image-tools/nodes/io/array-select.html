<script type="text/javascript">
    RED.nodes.registerType('array-select', {
        category: 'RP Image',
        color: '#7b8dff',
        defaults: {
            name: { value: "" },
            inputPath: { value: "payload" },
            inputPathType: { value: "msg" },
            selection: { value: "0" },
            asArray: { value: false }
        },
        inputs: 1,
        outputs: 1,
        icon: "font-awesome/fa-columns",
        label: function() {
            if (this.name) return this.name;
            return `Array Select [${this.selection}]`;
        },
        oneditprepare: function() {
            // Set up TypedInput for input path
            $("#node-input-inputPath").typedInput({
                default: 'msg',
                types: ['msg', 'flow', 'global'],
                typeField: "#node-input-inputPathType"
            });
        }
    });
</script>

<script type="text/x-red" data-template-name="array-select">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    
    <hr>
    
    <div class="form-row">
        <label for="node-input-inputPath"><i class="fa fa-sign-in"></i> Input from</label>
        <input type="text" id="node-input-inputPath" style="width: 70%;">
        <input type="hidden" id="node-input-inputPathType">
    </div>
    
    <div class="form-row">
        <label for="node-input-selection"><i class="fa fa-filter"></i> Selection</label>
        <input type="text" id="node-input-selection" style="width: 70%;" placeholder="e.g., 0, 1,3,5, 1:4, 0::2">
    </div>
    
    <div class="form-row">
        <label for="node-input-asArray"><i class="fa fa-list"></i> Force Array</label>
        <input type="checkbox" id="node-input-asArray">
        <span style="margin-left: 5px;">Always output as array (even for single items)</span>
    </div>
    
    <div class="form-tips">
        <b>Selection Examples:</b><br>
        • <code>0</code> - First element<br>
        • <code>1,3,5</code> - Elements at indices 1, 3, 5<br>
        • <code>1:4</code> - Elements 1 to 3 (range)<br>
        • <code>0::2</code> - Every 2nd element starting from 0<br>
        • <code>-1</code> - Last element<br>
        • <code>-2:-1</code> - Last two elements
    </div>
</script>

<script type="text/x-red" data-help-name="array-select">
    <p>Selects elements from an input array using flexible selection syntax.</p>
    
    <h3>Properties</h3>
    <dl class="message-properties">
        <dt>Input from <span class="property-type">string</span></dt>
        <dd>The location to read the input array from. You can select between <code>msg</code>, <code>flow</code>, or <code>global</code> context.</dd>
        <dt>Selection <span class="property-type">string</span></dt>
        <dd>Specify which array elements to select using various formats.</dd>
        <dt>Force Array <span class="property-type">boolean</span></dt>
        <dd>When checked, always outputs an array even for single elements.</dd>
    </dl>

    <h3>Selection Formats</h3>
    <ul>
        <li><strong>Single Index:</strong> <code>0</code>, <code>2</code>, <code>-1</code> (negative indices count from end)</li>
        <li><strong>Multiple Indices:</strong> <code>0,2,4</code>, <code>1,3,5</code> (comma-separated)</li>
        <li><strong>Range:</strong> <code>1:4</code> (indices 1 to 3), <code>0:5</code> (indices 0 to 4)</li>
        <li><strong>Step Range:</strong> <code>0::2</code> (every 2nd element), <code>1:7:2</code> (indices 1,3,5)</li>
    </ul>

    <h3>Input Requirements</h3>
    <p><strong>Input must always be an array.</strong> The node will warn and skip processing if the input is not an array.</p>

    <h3>Output Behavior</h3>
    <ul>
        <li><strong>Single Element:</strong> Outputs the element directly (unless "Force Array" is checked)</li>
        <li><strong>Multiple Elements:</strong> Always outputs as an array</li>
        <li><strong>Invalid Selection:</strong> No message sent, warning logged</li>
        <li><strong>Out of Bounds:</strong> Invalid indices are ignored, warning logged</li>
    </ul>

    <h3>Examples</h3>
    <p><strong>Input:</strong> <code>[\"A\", \"B\", \"C\", \"D\", \"E\"]</code></p>
    <ul>
        <li><code>0</code> → <code>\"A\"</code></li>
        <li><code>1,3</code> → <code>[\"B\", \"D\"]</code></li>
        <li><code>1:4</code> → <code>[\"B\", \"C\", \"D\"]</code></li>
        <li><code>0::2</code> → <code>[\"A\", \"C\", \"E\"]</code></li>
        <li><code>-1</code> → <code>\"E\"</code> (last element)</li>
        <li><code>-2:-1</code> → <code>[\"D\", \"E\"]</code> (last two elements)</li>
    </ul>

    <h3>Error Handling</h3>
    <p>The node provides comprehensive validation and error reporting:</p>
    <ul>
        <li>Warns if input is not an array</li>
        <li>Warns if input array is empty</li>
        <li>Warns for invalid selection syntax</li>
        <li>Warns for out-of-bounds indices</li>
        <li>Node status shows current processing state</li>
    </ul>
</script>