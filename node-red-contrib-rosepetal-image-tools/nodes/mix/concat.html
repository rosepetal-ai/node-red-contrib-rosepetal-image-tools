<!-- nodes/rosepetal-concat/concat.html -->

<script type="text/javascript">
    RED.nodes.registerType('concat',{
      category:'RP Image',
      color:'#DDA0DD',
      icon:'font-awesome/fa-th-large',
      defaults:{
        name:{value:""},
        inputPath:{value:"payload"}, inputPathType:{value:"msg"},
        outputPath:{value:"payload"},outputPathType:{value:"msg"},
        outputFormat:{value:"raw"},
        outputQuality:{value:90},
        direction:{value:"right"},            // right|left|down|up
        strategy :{value:"pad-start"},        // pad-start|pad-end|pad-both|resize
        padColor :{value:"#000000"}
      },
      inputs:1,outputs:1,
      label:function(){return this.name||"concat";},
      oneditprepare:function(){
        /* path typedInputs */
        $("#node-input-inputPath").typedInput({
          default:'msg',types:['msg','flow','global'],
          typeField:"#node-input-inputPathType"});
        $("#node-input-outputPath").typedInput({
          default:'msg',types:['msg','flow','global'],
          typeField:"#node-input-outputPathType"});

        /* colour‑row toggle (only change added) */
        const $strategy=$("#node-input-strategy");
        const $padRow  =$("#pad-colour-row");
        function toggleColour(){ $padRow.toggle($strategy.val()!=="resize"); }
        $strategy.on("change",toggleColour);
        toggleColour();         /* initial state */
        
        function updateQualityVisibility(){
          const format = $("#node-input-outputFormat").val();
          $("#quality-row").toggle(format === "jpg" || format === "webp");
        }
        $("#node-input-outputFormat").on("change", updateQualityVisibility);
        updateQualityVisibility(); // initial state
      }
    });
  </script>

  <script type="text/x-red" data-template-name="concat">
    <div class="form-row">
      <label><i class="fa fa-sign-in"></i> Input</label>
      <input type="text" id="node-input-inputPath" style="width:70%;">
      <input type="hidden" id="node-input-inputPathType">
    </div>
    <div class="form-row">
      <label><i class="fa fa-sign-out"></i> Output</label>
      <input type="text" id="node-input-outputPath" style="width:70%;">
      <input type="hidden" id="node-input-outputPathType">
    </div>
    <div class="form-row">
      <label for="node-input-outputFormat"><i class="fa fa-file-image-o"></i> Output Format</label>
      <select id="node-input-outputFormat" style="width: 200px;">
        <option value="raw">Raw (fastest)</option>
        <option value="jpg">JPEG</option>
        <option value="png">PNG</option>
        <option value="webp">WebP</option>
      </select>
    </div>
    <div class="form-row" id="quality-row">
      <label for="node-input-outputQuality"><i class="fa fa-sliders"></i> Quality</label>
      <input type="number" id="node-input-outputQuality" min="1" max="100" value="90" style="width: 70px;">
      <span style="margin-left: 10px; color: #666;">1-100 (JPG/WebP only)</span>
    </div>
    <hr/>
    <div class="form-row">
      <label><i class="fa fa-arrows-h"></i> Direction</label>
      <select id="node-input-direction">
        <option value="right">→ Right</option>
        <option value="left">← Left</option>
        <option value="down">↓ Down</option>
        <option value="up">↑ Up</option>
      </select>
    </div>
    <div class="form-row">
      <label><i class="fa fa-th"></i> Strategy</label>
      <select id="node-input-strategy">
        <option value="pad-start">Pad at start</option>
        <option value="pad-end">Pad at end</option>
        <option value="pad-both">Pad both sides</option>
        <option value="resize">Resize to max</option>
      </select>
    </div>
    <!-- único cambio: id para poder toggle‑ar -->
    <div class="form-row" id="pad-colour-row">
      <label for="node-input-padColor"><i class="fa fa-tint"></i> Pad colour</label>
      <input type="color" id="node-input-padColor" style="width:80px;">
    </div>
  </script>

  <script type="text/x-red" data-help-name="concat">
    <p><b>rosepetal-concat</b> stitches multiple images into one.</p>
    <ul>
      <li><b>Direction</b> — choose horizontal (→/←) or vertical (↓/↑).</li>
      <li><b>Strategy</b> — how to fill extra space:
        <ul>
          <li><em>Pad start/end/both</em> (uses the selected colour).</li>
          <li><em>Resize</em> — scale smaller images up so no gaps remain.</li>
        </ul>
      </li>
    </ul>
    <p>Tick <em>JPG</em> to get a JPEG buffer, otherwise a raw object.</p>
    <p>The status shows timings: <code>conv | task | enc</code>.</p>
  </script>
