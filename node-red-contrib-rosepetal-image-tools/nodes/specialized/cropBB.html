<!-- ───────── nodes/io/cropBB.html (Crop Bounding Boxes Node) ────────────── -->

<!-- 1 ▸ Runtime registration -->
<script type="text/javascript">
  RED.nodes.registerType('cropBB',{
  
    category:'RP Image',
    color   :'#FF6B35',  // Distinct orange color to differentiate from standard pink
    icon    :'font-awesome/fa-scissors',
  
    defaults:{
      name:{value:""},
      imageInputPath:{value:"images"},   imageInputPathType:{value:"msg"},
      bboxInputPath:{value:"default"},  bboxInputPathType:{value:"msg"},
      outputPath:{value:"payload"},  outputPathType:{value:"msg"},
      outputFormat:{value:"raw"},
      outputQuality:{value:90},
      pngOptimize:{value:false},
      
      // Filtering options
      minConfidence:{value:0.5},
      minConfidenceType:{value:"num"},
      
      // Debug configuration
      debugEnabled:{value:false},
      debugWidth:{value:200},
      debugWidthType:{value:"num"}
    },
  
    inputs:1, outputs:1,
    label:function(){ return this.name || "cropBB"; },
  
    /* ---------------- oneditprepare ---------------- */
    oneditprepare:function(){
  
      /* I/O typedInputs */
      $("#node-input-imageInputPath").typedInput({
        default:'msg',types:['msg','flow','global'],
        typeField:"#node-input-imageInputPathType"
      });
      
      $("#node-input-bboxInputPath").typedInput({
        default:'msg',types:['msg','flow','global'],
        typeField:"#node-input-bboxInputPathType"
      });
      
      $("#node-input-outputPath").typedInput({
        default:'msg',types:['msg','flow','global'],
        typeField:"#node-input-outputPathType"
      });

      /* confidence threshold */
      $("#node-input-minConfidence").typedInput({
        default:'num',
        types:['num','msg','flow','global'],
        typeField:"#node-input-minConfidenceType"
      });

      /* debug width */
      $("#node-input-debugWidth").typedInput({
        default:'num',
        types:['num','msg','flow','global'],
        typeField:"#node-input-debugWidthType"
      });

      /* Quality visibility logic */
      function updateQualityVisibility() {
        const format = $('#node-input-outputFormat').val();
        if (format === 'jpg' || format === 'webp') {
          $('#quality-row').show();
        } else {
          $('#quality-row').hide();
        }
        $('#png-optimize-row').toggle(format === 'png');
      }

      $('#node-input-outputFormat').on('change', updateQualityVisibility);
      updateQualityVisibility(); // Initial call

      /* Debug visibility logic */
      function updateDebugWidthVisibility() {
        if ($('#node-input-debugEnabled').is(':checked')) {
          $('#debug-width-row').show();
        } else {
          $('#debug-width-row').hide();
        }
      }

      $('#node-input-debugEnabled').on('change', updateDebugWidthVisibility);
      updateDebugWidthVisibility(); // Initial call
    }
  });
</script>

<!-- 2 ▸ Edit template -->
<script type="text/html" data-template-name="cropBB">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <hr>

  <!-- I/O Section -->
  <div class="form-row">
    <label for="node-input-imageInputPath"><i class="fa fa-sign-in"></i> Input from</label>
    <input type="text" id="node-input-imageInputPath" style="width: 70%;">
    <input type="hidden" id="node-input-imageInputPathType">
  </div>
  <div class="form-row">
    <label for="node-input-bboxInputPath"><i class="fa fa-square-o"></i> Bounding Boxes</label>
    <input type="text" id="node-input-bboxInputPath" style="width: 70%;">
    <input type="hidden" id="node-input-bboxInputPathType">
  </div>
  <div class="form-row">
    <label for="node-input-outputPath"><i class="fa fa-sign-out"></i> Output to</label>
    <input type="text" id="node-input-outputPath" style="width: 70%;">
    <input type="hidden" id="node-input-outputPathType">
  </div>
  <div class="form-row">
    <label for="node-input-outputFormat"><i class="fa fa-file-image-o"></i> Output Format</label>
    <select id="node-input-outputFormat" style="width: 200px;">
      <option value="raw">Raw (fastest)</option>
      <option value="jpg">JPEG</option>
      <option value="png">PNG</option>
      <option value="webp">WebP</option>
    </select>
  </div>
  <div class="form-row" id="quality-row">
    <label for="node-input-outputQuality"><i class="fa fa-sliders"></i> Quality</label>
    <input type="number" id="node-input-outputQuality" min="1" max="100" value="90" style="width: 70px;">
    <span style="margin-left: 10px; color: #666;">1-100 (JPG/WebP only)</span>
  </div>
  
  <div class="form-row" id="png-optimize-row" style="display: none;">
    <label for="node-input-pngOptimize"><i class="fa fa-compress"></i> PNG Optimize</label>
    <input type="checkbox" id="node-input-pngOptimize" style="display:inline-block; width:auto; vertical-align:baseline;">
    <label for="node-input-pngOptimize" style="width:auto; margin-left:5px;">Compress PNG (slower, smaller file)</label>
  </div>

  <!-- Debug Configuration -->
  <div class="form-row">
    <label for="node-input-debugEnabled"><i class="fa fa-bug"></i> Debug</label>
    <input type="checkbox" id="node-input-debugEnabled" style="display:inline-block; width:auto; vertical-align:baseline;">
    <label for="node-input-debugEnabled" style="width:auto; margin-left:5px;">Show processed image</label>
  </div>
  <div class="form-row" id="debug-width-row" style="display: none;">
    <label for="node-input-debugWidth"><i class="fa fa-arrows-h"></i> Debug Width</label>
    <input type="text" id="node-input-debugWidth" style="width: 120px;">
    <input type="hidden" id="node-input-debugWidthType">
    <span style="margin-left: 10px; color: #666;">pixels</span>
  </div>

  <hr>

  <!-- CropBB Specific Options -->
  <div class="form-row">
    <label for="node-input-minConfidence"><i class="fa fa-filter"></i> Min Confidence</label>
    <input type="text" id="node-input-minConfidence" style="width: 70%;">
    <input type="hidden" id="node-input-minConfidenceType">
  </div>

</script>

<!-- 3 ▸ Help documentation -->
<script type="text/html" data-help-name="cropBB">
  <p>Extracts image crops from bounding boxes detected by inference models.</p>
  
  <h3>Details</h3>
  <p>This node takes images and their corresponding bounding box data (typically from an inferencer node) 
  and extracts each detected region as a separate image crop. Each crop is paired with its detection metadata.</p>
  
  <h3>Inputs</h3>
  <dl class="message-properties">
    <dt>Image Input<span class="property-type">image | image[]</span></dt>
    <dd>Single image or array of images in standard Rosepetal format</dd>
    
    <dt>Bounding Boxes<span class="property-type">object | object[]</span></dt>
    <dd>Detection results from inferencer node containing bounding box coordinates, labels, and confidence scores</dd>
  </dl>
  
  <h3>Outputs</h3>
  <dl class="message-properties">
    <dt>crops<span class="property-type">array</span></dt>
    <dd>Array of objects with structure: <code>[{crop: imageObject, tag: {label, confidence, bbox}}, ...]</code></dd>
  </dl>
  
  <h3>Configuration</h3>
  <dl class="message-properties">
    <dt>Image Input</dt>
    <dd>Path to image data (default: <code>msg.images</code>)</dd>
    
    <dt>Bounding Boxes</dt>
    <dd>Path to inference results (default: <code>msg.default</code>)</dd>
    
    <dt>Output Format</dt>
    <dd>Raw (fastest), JPEG, PNG, or WebP encoding</dd>
    
    <dt>Min Confidence</dt>
    <dd>Filter out detections below this confidence threshold (0.0-1.0)</dd>
    
    <dt>Debug</dt>
    <dd>Enable debug image display in Node-RED editor</dd>
  </dl>
  
  <h3>Example Output</h3>
  <pre>[
  {
    crop: {data: Buffer, width: 150, height: 200, channels: 3, colorSpace: "RGB"},
    tag: {label: "person", confidence: 0.95, bbox: {x: 100, y: 50, width: 150, height: 200}}
  },
  {
    crop: {data: Buffer, width: 80, height: 120, channels: 3, colorSpace: "RGB"},
    tag: {label: "car", confidence: 0.87, bbox: {x: 300, y: 200, width: 80, height: 120}}
  }
]</pre>
  
  <h3>Performance</h3>
  <p>Uses optimized C++ backend for fast crop extraction. Multiple crops are processed in parallel for best performance.</p>
</script>