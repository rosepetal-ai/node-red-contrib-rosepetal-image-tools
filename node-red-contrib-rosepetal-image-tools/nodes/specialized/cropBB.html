<!-- ───────── nodes/io/cropBB.html (Crop Bounding Boxes Node) ────────────── -->

<!-- 1 ▸ Runtime registration -->
<script type="text/javascript">
  RED.nodes.registerType('cropBB',{
  
    category:'RP Image',
    color   :'#FF6B35',  // Distinct orange color to differentiate from standard pink
    icon    :'font-awesome/fa-scissors',
  
    defaults:{
      name:{value:""},
      imageInputPath:{value:"images"},   imageInputPathType:{value:"msg"},
      bboxInputPath:{value:"default"},  bboxInputPathType:{value:"msg"},
      outputPath:{value:"payload"},  outputPathType:{value:"msg"},
      outputFormat:{value:"raw"},
      outputQuality:{value:90},
      
      // Filtering options
      minConfidence:{value:0.5},
      minConfidenceType:{value:"num"},
      
      // Debug configuration
      debugEnabled:{value:false},
      debugWidth:{value:200},
      debugWidthType:{value:"num"}
    },
  
    inputs:1, outputs:1,
    label:function(){ return this.name || "cropBB"; },
  
    /* ---------------- oneditprepare ---------------- */
    oneditprepare:function(){
  
      /* I/O typedInputs */
      $("#node-input-imageInputPath").typedInput({
        default:'msg',types:['msg','flow','global'],
        typeField:"#node-input-imageInputPathType"
      });
      
      $("#node-input-bboxInputPath").typedInput({
        default:'msg',types:['msg','flow','global'],
        typeField:"#node-input-bboxInputPathType"
      });
      
      $("#node-input-outputPath").typedInput({
        default:'msg',types:['msg','flow','global'],
        typeField:"#node-input-outputPathType"
      });

      /* confidence threshold */
      $("#node-input-minConfidence").typedInput({
        default:'num',
        types:['num','msg','flow','global'],
        typeField:"#node-input-minConfidenceType"
      });

      /* debug width */
      $("#node-input-debugWidth").typedInput({
        default:'num',
        types:['num','msg','flow','global'],
        typeField:"#node-input-debugWidthType"
      });

      /* debug toggle */
      $("#node-input-debugEnabled").on("change", function(){
        const enabled = $(this).prop("checked");
        $("#debug-options").toggle(enabled);
      });
      
      // Initial state
      $("#debug-options").toggle($("#node-input-debugEnabled").prop("checked"));
    }
  });
</script>

<!-- 2 ▸ Edit template -->
<script type="text/html" data-template-name="cropBB">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <!-- Input Paths -->
  <div class="form-row">
    <label for="node-input-imageInputPath"><i class="fa fa-picture-o"></i> Image Input</label>
    <input style="width:70%" type="text" id="node-input-imageInputPath" placeholder="images">
    <input type="hidden" id="node-input-imageInputPathType">
  </div>

  <div class="form-row">
    <label for="node-input-bboxInputPath"><i class="fa fa-square-o"></i> Bounding Boxes</label>
    <input style="width:70%" type="text" id="node-input-bboxInputPath" placeholder="default">
    <input type="hidden" id="node-input-bboxInputPathType">
  </div>

  <!-- Output Configuration -->
  <div class="form-row">
    <label for="node-input-outputPath"><i class="fa fa-sign-out"></i> Output</label>
    <input style="width:70%" type="text" id="node-input-outputPath" placeholder="payload">
    <input type="hidden" id="node-input-outputPathType">
  </div>

  <div class="form-row">
    <label for="node-input-outputFormat"><i class="fa fa-file-image-o"></i> Output Format</label>
    <select id="node-input-outputFormat" style="width:70%;">
      <option value="raw">Raw (fastest)</option>
      <option value="jpg">JPEG</option>
      <option value="png">PNG</option>
      <option value="webp">WebP</option>
    </select>
  </div>

  <div class="form-row">
    <label for="node-input-outputQuality"><i class="fa fa-sliders"></i> Quality</label>
    <input type="range" id="node-input-outputQuality" min="1" max="100" style="width:60%;">
    <span id="quality-value">90</span>%
  </div>

  <!-- Filtering Options -->
  <div class="form-row">
    <label for="node-input-minConfidence"><i class="fa fa-filter"></i> Min Confidence</label>
    <input style="width:70%" type="text" id="node-input-minConfidence" placeholder="0.5">
    <input type="hidden" id="node-input-minConfidenceType">
  </div>

  <!-- Debug Options -->
  <div class="form-row">
    <label for="node-input-debugEnabled"><i class="fa fa-bug"></i> Debug</label>
    <input type="checkbox" id="node-input-debugEnabled" style="display:inline-block; width:auto; vertical-align:top;">
    <label for="node-input-debugEnabled" style="width:70%;">Enable debug image display</label>
  </div>

  <div id="debug-options" style="display:none;">
    <div class="form-row">
      <label for="node-input-debugWidth"><i class="fa fa-arrows-h"></i> Debug Width</label>
      <input style="width:70%" type="text" id="node-input-debugWidth" placeholder="200">
      <input type="hidden" id="node-input-debugWidthType">
    </div>
  </div>

  <script>
    // Quality slider sync
    $("#node-input-outputQuality").on("input", function(){
      $("#quality-value").text($(this).val());
    });
    
    // Initialize quality display
    setTimeout(function(){
      $("#quality-value").text($("#node-input-outputQuality").val());
    }, 100);
  </script>
</script>

<!-- 3 ▸ Help documentation -->
<script type="text/html" data-help-name="cropBB">
  <p>Extracts image crops from bounding boxes detected by inference models.</p>
  
  <h3>Details</h3>
  <p>This node takes images and their corresponding bounding box data (typically from an inferencer node) 
  and extracts each detected region as a separate image crop. Each crop is paired with its detection metadata.</p>
  
  <h3>Inputs</h3>
  <dl class="message-properties">
    <dt>Image Input<span class="property-type">image | image[]</span></dt>
    <dd>Single image or array of images in standard Rosepetal format</dd>
    
    <dt>Bounding Boxes<span class="property-type">object | object[]</span></dt>
    <dd>Detection results from inferencer node containing bounding box coordinates, labels, and confidence scores</dd>
  </dl>
  
  <h3>Outputs</h3>
  <dl class="message-properties">
    <dt>crops<span class="property-type">array</span></dt>
    <dd>Array of objects with structure: <code>[{crop: imageObject, tag: {label, confidence, bbox}}, ...]</code></dd>
  </dl>
  
  <h3>Configuration</h3>
  <dl class="message-properties">
    <dt>Image Input</dt>
    <dd>Path to image data (default: <code>msg.images</code>)</dd>
    
    <dt>Bounding Boxes</dt>
    <dd>Path to inference results (default: <code>msg.default</code>)</dd>
    
    <dt>Output Format</dt>
    <dd>Raw (fastest), JPEG, PNG, or WebP encoding</dd>
    
    <dt>Min Confidence</dt>
    <dd>Filter out detections below this confidence threshold (0.0-1.0)</dd>
    
    <dt>Debug</dt>
    <dd>Enable debug image display in Node-RED editor</dd>
  </dl>
  
  <h3>Example Output</h3>
  <pre>[
  {
    crop: {data: Buffer, width: 150, height: 200, channels: 3, colorSpace: "RGB"},
    tag: {label: "person", confidence: 0.95, bbox: {x: 100, y: 50, width: 150, height: 200}}
  },
  {
    crop: {data: Buffer, width: 80, height: 120, channels: 3, colorSpace: "RGB"},
    tag: {label: "car", confidence: 0.87, bbox: {x: 300, y: 200, width: 80, height: 120}}
  }
]</pre>
  
  <h3>Performance</h3>
  <p>Uses optimized C++ backend for fast crop extraction. Multiple crops are processed in parallel for best performance.</p>
</script>